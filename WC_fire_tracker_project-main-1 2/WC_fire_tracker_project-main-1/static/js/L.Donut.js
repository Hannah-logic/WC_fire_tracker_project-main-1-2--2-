L.Donut=L.Circle.extend({initialize:function(i,t,n){if(L.Circle.prototype.initialize.call(this,i,t,n),isNaN(this.options.innerRadius))throw Error("Inner radius cannot be NaN");if(this.options.innerRadius>=this.options.radius)throw Error("Outer radius must be greater then the inner radius");this._mInnerRadius=this.options.innerRadius},setRadius:function(i){if(this._mInnerRadius>=i)throw Error("Outer radius must be greater then the inner radius");return L.Circle.prototype.setRadius.call(this,i)},setInnerRadius:function(i){if(i>this._mRadius)throw Error("Inner radius must be smaller then the outer radius");return this.options.innerRadius=this._mInnerRadius=i,this.redraw()},getInnerRadius:function(){return this._mInnerRadius},_updatePath:function(){this._renderer._updateDonut(this)},_project:function(){var i=this._map,t=i.options.crs;if(t.distance===L.CRS.Earth.distance){var n=this._radiusCalculation(this._mRadius);this._point=n.point,this._radius=n.radius,this._radiusY=n.radiusY;var s=0;if(this.options.innerRadiusAsPercent){var r=this._mInnerRadius>1?1:this._mInnerRadius;s=this._mRadius*r}else s=this._mInnerRadius;var a=this._radiusCalculation(s);this._innerPoint=a.point,this._innerRadius=a.radius,this._innerRadiusY=a.radiusY}else{var e=t.unproject(t.project(this._latlng).subtract([this._mRadius,0]));this._point=i.latLngToLayerPoint(this._latlng),this._radius=this._point.x-i.latLngToLayerPoint(e).x}this._updateBounds()},_radiusCalculation:function(i){var t=this._latlng.lng,n=this._latlng.lat,s=this._map,r=Math.PI/180,a=i/L.CRS.Earth.R/r,e=s.project([n+a,t]),u=s.project([n-a,t]),o=e.add(u).divideBy(2),d=s.unproject(o).lat,h=Math.acos((Math.cos(a*r)-Math.sin(n*r)*Math.sin(d*r))/(Math.cos(n*r)*Math.cos(d*r)))/r;return(isNaN(h)||0===h)&&(h=a/Math.cos(Math.PI/180*n)),{point:o.subtract(s.getPixelOrigin()),radius:isNaN(h)?0:o.x-s.project([d,t-h]).x,radiusY:o.y-e.y}}}),L.donut=function(i,t){return new L.Donut(i,t)},L.SVG.include({_updateDonut:function(i){var t,n=i._point,s=Math.max(Math.round(i._radius),1),r=Math.max(Math.round(i._radiusY),1)||s,a="a"+s+","+r+" 0 1,0 ",e=i._innerPoint,u=Math.max(Math.round(i._innerRadius),1),o=Math.max(Math.round(i._innerRadiusY),1)||u,d="a"+u+","+o+" 0 1,0 ";i._empty()?t="M0 0":(t="M"+(n.x-s)+","+n.y+a+2*s+",0 "+a+-(2*s)+",0 ",t+="M"+(e.x-u)+","+e.y+d+2*u+",0 "+d+-(2*u)+",0 "),this._setPath(i,t)}}),L.Canvas.include({_updateDonut:function(i){if(!(!this._drawing||i._empty())){var t=i._point,n=this._ctx,s=Math.max(Math.round(i._radius),1),r=(Math.max(Math.round(i._radiusY),1)||s)/s,a=i._innerPoint,e=Math.max(Math.round(i._innerRadius),1),u=(Math.max(Math.round(i._innerRadiusY),1)||e)/e;1!==r&&(n.save(),n.scale(1,r)),n.beginPath(),n.arc(t.x,t.y/r,s,0,2*Math.PI,!1),n.moveTo(t.x+e,t.y),n.arc(a.x,a.y/u,e,0,2*Math.PI,!0),1!==r&&n.restore(),this._fillStroke(n,i)}}});